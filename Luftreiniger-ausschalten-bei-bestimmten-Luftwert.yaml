blueprint:
  name: Luftreiniger Auto-Schaltung (Mehrfach)
  description: |
    <br>
    <b>üìòDieser Blueprint schaltet mehrere Luftreiniger nach Entit√§ten, Schaltern oder manuellen Schaltern am Ger√§t ein und automatisch wieder aus. Zeitversatz nachdem die Aktion ausgef√ºhrt wird liegt bei 3min.</b>
    <br><br>
    üìÖ <b>Schalter, Entit√§ten, Bereiche</b>: Luftreiniger werden nach Schalter, Entit√§ten oder Bereichen eingeschaltet und nach gesetztem Luftwert automatisch wieder abgeschaltet.<br>
    ‚è∞ <b>Automatische Abschaltung</b>: Luftreiniger werden nach gesetztem Luftwert und manueller Ausl√∂sung am Ger√§t automatisch wieder abgeschaltet.
  domain: automation
  input:
    manual_toggle:
      name: Schalters bzw. Entit√§t
      description: Schalter o. Entit√§t, um Luftreiniger manuell zu aktivieren Abschaltung automatisch).
      selector:
        entity:
          domain: 
            - input_boolean
            - switch
            - light
            - fan
            - binary_sensor
    manual_toggle_state:
      name: Zustand des Schalters bzw. der Entit√§t
      description: Zustand, bei dem die Automatisierung ausgel√∂st wird (on oder off)
      default: "on"
      selector:
        select:
          options:
            - "on"
            - "off"
    pm2_5_sensor:
      name: PM2.5 Sensor
      description: PM2.5 Sensor f√ºr die Luftreiniger
      selector:
        entity:
          domain: sensor
    ppm_threshold:
      name: PM2.5 Grenzwert
      description: Grenzwert (PPM) f√ºr das Abschalten der Luftreiniger
      default: 50
      selector:
        number:
          min: 1
          max: 120
          step: 1
    fan_entities:
      name: Luftreiniger
      description: Entit√§ten, Bereiche oder Ger√§te der gew√ºnschten Luftreiniger
      selector:
        target:
          entity:
            domain: fan

trigger:
  - platform: state
    entity_id: !input pm2_5_sensor
    id: autooff
  - platform: state
    entity_id: !input manual_toggle
    to: !input manual_toggle_state
    id: manual

condition: []

action:
  - choose:
      # Automatische Steuerung basierend auf PM2.5
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'autooff' }}"
        sequence:
          - delay:
              minutes: 3  # 3 Minuten warten, um den realen PM2.5-Wert zu ermitteln
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            below: !input ppm_threshold  # Pr√ºfen, ob der PM2.5-Wert unter dem Grenzwert liegt
          - service: fan.turn_off
            target: !input fan_entities
      # Manuelle Steuerung
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'manual' }}"
        sequence:
          - service: fan.turn_on
            target: !input fan_entities
          - delay:
              minutes: 3  # 3 Minuten warten, um den realen PM2.5-Wert zu ermitteln
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            below: !input ppm_threshold  # Pr√ºfen, ob der PM2.5-Wert unter dem Grenzwert liegt
          - service: fan.turn_off
            target: !input fan_entities

mode: single
